// ---------- Styles ----------
const styles = `
:root{
  --bg:#f7f9fc; --card:#ffffff; --ink:#0f172a; --muted:#64748b; --line:#e2e8f0;
  --blue:#0ea5e9; --green:#22c55e; --gray:#94a3b8; --orange:#f97316;
  --shadow:0 6px 20px rgba(2,6,23,.08); --radius:16px;
}
*{box-sizing:border-box}
.wrap{max-width:1120px;margin:auto;padding:28px}
body{margin:0;background:linear-gradient(180deg,#fff,var(--bg));color:var(--ink);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif}
h1,h2,h3{margin:0 0 .5rem}
a{color:var(--blue)}
.header{display:flex;gap:16px;align-items:end;justify-content:space-between;margin-bottom:18px}
.badge{background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px 14px;box-shadow:var(--shadow)}
.card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
.grid{display:grid;gap:16px}
@media(min-width:900px){.grid-2{grid-template-columns:1fr 1fr}}
.legend{display:flex;gap:12px;align-items:center;color:var(--muted);font-size:12px}
.dot{width:10px;height:10px;border-radius:50%}
.module{background:#f8fafc;border:1px solid var(--line);border-radius:14px;padding:14px}
.module h3{font-size:16px}
.row{display:flex;align-items:flex-start;gap:10px}
.cb{width:16px;height:16px;margin-top:2px}
.muted{color:var(--muted)}
.kpi{height:8px;background:#fff;border:1px solid var(--line);border-radius:999px;overflow:hidden;margin:10px 0}
.kpi>i{display:block;height:100%}
.pill{display:inline-flex;gap:6px;align-items:center;font-size:12px;color:var(--muted)}
.spacer{height:10px}
.title{font-weight:800;font-size:26px}
.sub{color:var(--muted)}
.btn{appearance:none;border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 10px;font-size:13px;cursor:pointer}
.btn:hover{border-color:#cbd5e1}
.right{margin-left:auto}
.tiny{font-size:12px}
.edit-link{opacity:.7;cursor:pointer}
.edit-link:hover{opacity:1}
.timeline{overflow-x:auto;padding-bottom:6px}
.tl{display:flex;gap:18px;align-items:center;min-width:900px}
.tl .b{position:relative;display:flex;flex-direction:column;align-items:center;gap:4px}
.tl .ball{width:32px;height:32px;border-radius:999px;display:grid;place-items:center;color:#fff;font-weight:700;box-shadow:var(--shadow)}
.tl .line{position:absolute;top:16px;left:-38px;width:38px;height:2px;background:var(--line)}
.week{background:#f1f5f9;border:1px solid var(--line);border-radius:12px;padding:12px}
.footer{color:var(--muted);text-align:center;margin:20px 0 40px}
.settings{display:flex;gap:10px;flex-wrap:wrap}
.settings input[type="file"]{display:none}
`;

// ---------- Helpers ----------
const slug = (s: string) => s
  .toLowerCase()
  .normalize("NFD")
  .replace(/[\u0300-\u036f]/g, "") // remove diacritics
  .replace(/[^a-z0-9]+/g, "-")
  .replace(/(^-|-$)/g, "");

const loadJSON = <T,>(k: string): T | null => { try { const r = localStorage.getItem(k); return r ? JSON.parse(r) as T : null; } catch { return null; } };
const saveJSON = (k: string, v: unknown) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch {} };

// ---------- Types ----------
type Week = { id: number; label: string; month: string; color: string; title: string; tasks: string[] };

type ModuleDef = { title: string; prio: keyof typeof PRIORITY; items: string[] };

// ---------- Constants (use CSS vars directly to avoid getComputedStyle timing) ----------
const PRIORITY = {
  MASTER: { label: "Ã€ maÃ®triser", color: "var(--blue)" },
  LEARN:  { label: "Ã€ apprendre", color: "var(--green)" },
  AWARE:  { label: "Culture gÃ©nÃ©rale", color: "var(--gray)" }
} as const;

const WEEKS: Week[] = [
  { id:1, label:"S1", month:"FÃ©vrier", color:"var(--blue)",  title:"Bases Python", tasks:["Variables, conditions, boucles","Fonctions simples","Lire/Ã©crire des fichiers"]},
  { id:2, label:"S2", month:"FÃ©vrier", color:"var(--blue)",  title:"POO & organisation du code", tasks:["Classes & objets (bases)","HÃ©ritage simple","Modules & bibliothÃ¨ques","Miniâ€‘projet : calculatrice"]},
  { id:3, label:"S3", month:"FÃ©vrier", color:"var(--blue)",  title:"SQL â€“ bases de donnÃ©es", tasks:["SELECT/INSERT/UPDATE","ModÃ¨le simple RH (employÃ©s, salaires)","Jointures & filtres"]},
  { id:4, label:"S4", month:"FÃ©vrier", color:"var(--blue)",  title:"Miniâ€‘projet Python + SQL", tasks:["Importer CSV â†’ SQL","Script dâ€™extraction automatisÃ©","Affichage des rÃ©sultats"]},
  { id:5, label:"S5", month:"Mars",    color:"var(--green)", title:"API REST", tasks:["HTTP requests (GET/POST)","JSON & parsing","Connexion Ã  une API publique"]},
  { id:6, label:"S6", month:"Mars",    color:"var(--green)", title:"Pandas & NumPy", tasks:["Importer/Nettoyer un CSV","Stats descriptives","PrÃ©parer jeu RH/paie"]},
  { id:7, label:"S7", month:"Mars",    color:"var(--green)", title:"Dataâ€‘Viz (Matplotlib/Seaborn)", tasks:["Histogrammes & courbes","Salaires par service","Storytelling visuel"]},
  { id:8, label:"S8", month:"Mars",    color:"var(--green)", title:"Miniâ€‘projet API + Viz", tasks:["Appeler une API","Nettoyer avec Pandas","Graphique dynamique"]},
  { id:9, label:"S9", month:"Avril",   color:"var(--orange)",title:"Flask ou Streamlit", tasks:["Miniâ€‘app web/board","Page simple dÃ©ployÃ©e","Architecture propre"]},
  { id:10,label:"S10",month:"Avril",   color:"var(--orange)",title:"Projet â€“ Dashboard RH", tasks:["Base SQL + API + Viz","KPIs RH","Filtres & navigation"]},
  { id:11,label:"S11",month:"Avril",   color:"var(--orange)",title:"AmÃ©liorations + Doc", tasks:["Ergonomie","Doc utilisateur","Pitch de soutenance"]},
  { id:12,label:"S12",month:"Avril",   color:"var(--orange)",title:"Validation & RÃ©visions", tasks:["Tests finaux","Relecture Python/SQL","Q&A jury"]}
];

const MODULES: ModuleDef[] = [
  { title:"Piloter la production de contenus digitaux", prio:"AWARE", items:[
    "Pourquoi se former / Intro","Cible & brief crÃ©atif","Gestion & mise en place opÃ©rationnelle","Proposition & application"
  ]},
  { title:"HTML / CSS / Bootstrap", prio:"AWARE", items:[
    "HTML : structure, multimÃ©dia, formulaires","CSS : sÃ©lecteurs, boxâ€‘model, layout Grid/Flex, responsive","Bootstrap : grille, composants, Hello world","QualitÃ©, SASS, SEO, dÃ©ploiement"
  ]},
  { title:"JavaScript (Front)", prio:"AWARE", items:[
    "Ã‰vÃ©nementiel, DOM, Fetch/AJAX, Promesses","Objets & classes (bases)","JSON, Canvas","jQuery (culture)"
  ]},
  { title:"PHP (culture gÃ©nÃ©rale)", prio:"AWARE", items:[
    "Syntaxe, fonctions, tableaux, boucles","Superglobales, sÃ©curitÃ©, fichiers","POO, erreurs, MVC, ORM PHP"
  ]},
  { title:"Bases de donnÃ©es relationnelles (SQL)", prio:"MASTER", items:[
    "ModÃ¨le conceptuel & logique","CrÃ©er/alimenter une BDD, requÃªtes","Jointures, fonctions SQL","Projet : crÃ©er & administrer la BDD"
  ]},
  { title:"NoSQL / MongoDB", prio:"LEARN", items:["Concepts NoSQL","CrÃ©er & administrer MongoDB"]},
  { title:"Python â€“ fondamentaux", prio:"MASTER", items:[
    "InterprÃ©teur, environnements","Variables, conditions, boucles","Structures de donnÃ©es","Fonctions, modules, tests unitaires","POO : classes, hÃ©ritage, dunders"
  ]},
  { title:"Python â€“ Web & APIs", prio:"MASTER", items:[
    "Fichiers, chaÃ®nes, temps","RequÃªtes HTTP & API REST","Flask/Jinja, dÃ©ploiement","Django : modÃ¨les, vues"
  ]},
  { title:"Data & Visualisation (Python)", prio:"MASTER", items:[
    "NumPy / Pandas (bases â†’ +)","Matplotlib / Seaborn","Bokeh / Streamlit","PrÃ©sentations impactantes"
  ]},
  { title:"React Native (mobile)", prio:"AWARE", items:[
    "Expo, composants, state/props","Flexbox, navigation, Redux","SQLite local, dÃ©ploiement","Projet mobile (culture)"
  ]},
  { title:"Concevoir & utiliser des API", prio:"MASTER", items:[
    "Design dâ€™API, sÃ©curisation accÃ¨s","OAuth, APIs Google/AWS, paiements","Utilisation & intÃ©gration"
  ]},
  { title:"Git / GitHub / GitLab", prio:"LEARN", items:[
    "CLI, init/commit/push","Branches & rebase","Bonnes pratiques, projet GitHub","Intro GitLab"
  ]},
  { title:"Maintenance & documentation", prio:"LEARN", items:[
    "Doc dâ€™architecture & code","AmÃ©liorations, doc utilisateur","Dette technique (notions)","Pentest (culture)"
  ]}
];

// ---------- Component ----------
export default function MathildePlanApp() {
  // style injection
  useEffect(() => {
    const tag = document.createElement("style"); tag.innerHTML = styles; document.head.appendChild(tag);
    return () => { try { document.head.removeChild(tag); } catch {} };
  }, []);

  // weeks & active selection
  const weeks = useMemo(() => WEEKS, []);
  const [activeWeek, setActiveWeek] = useState<Week>(weeks[0]);

  // storage state
  const STORAGE_PROGRESS = "mathilde-progress-v1";
  const STORAGE_LINKS    = "mathilde-links-v1";
  const [progress, setProgress] = useState<Record<string, Record<string, boolean>>>(() => loadJSON(STORAGE_PROGRESS) || {});
  const [links, setLinks]       = useState<Record<string, Record<string, string>>>(() => loadJSON(STORAGE_LINKS) || {});
  useEffect(() => { saveJSON(STORAGE_PROGRESS, progress); }, [progress]);
  useEffect(() => { saveJSON(STORAGE_LINKS, links); }, [links]);

  const modules = useMemo(() => MODULES, []);

  const toggle = (moduleTitle: string, item: string) => {
    const m = slug(moduleTitle), k = slug(item);
    setProgress(prev => ({ ...prev, [m]: { ...(prev[m]||{}), [k]: !prev[m]?.[k] } }));
  };
  const computeProgress = (moduleTitle: string, items: string[]) => {
    const m = slug(moduleTitle); const done = items.filter(it => progress[m]?.[slug(it)]).length;
    return Math.round((done / items.length) * 100);
  };
  const setItemLink = (moduleTitle: string, item: string) => {
    const m = slug(moduleTitle), k = slug(item);
    const current = links[m]?.[k] || "";
    const newUrl = window.prompt(`Colle le lien Google Drive du PDF pour:\n${moduleTitle} â†’ ${item}`, current);
    if (newUrl !== null) setLinks(prev => ({ ...prev, [m]: { ...(prev[m]||{}), [k]: newUrl.trim() } }));
  };

  // export / import / reset
  const fileRef = useRef<HTMLInputElement>(null);
  const onExport = () => {
    const blob = new Blob([JSON.stringify({ progress, links }, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob); const a = document.createElement("a");
    a.href = url; a.download = "mathilde_progress.json"; a.click(); URL.revokeObjectURL(url);
  };
  const onImport = (e: React.ChangeEvent<HTMLInputElement>) => {
    const f = e.target.files?.[0]; if (!f) return;
    const rd = new FileReader();
    rd.onload = () => {
      try { const data = JSON.parse(String(rd.result)); setProgress(data.progress||{}); setLinks(data.links||{}); alert("Import OK âœ”"); }
      catch { alert("Fichier invalide"); }
    };
    rd.readAsText(f); e.target.value = "";
  };
  const onReset = () => { if (confirm("RÃ©initialiser toute la progression et les liens ?")) { setProgress({}); setLinks({}); } };

  // helper for mass pasting links
  useEffect(() => { (window as any).pasteLinksSequential = (arr: string[]) => {
    let idx = 0; setLinks(prev => {
      const draft: Record<string, Record<string, string>> = { ...prev };
      modules.forEach(m => { const ms = slug(m.title); draft[ms] = draft[ms] || {}; m.items.forEach(it => { if (idx < arr.length) draft[ms][slug(it)] = String(arr[idx++]); }); });
      return draft; });
  }; }, [modules]);

  // ---------- Self-tests ----------
  useEffect(() => {
    try {
      console.assert(slug("Ã‰lÃ©vation des coÃ¼ts!") === "elevation-des-couts", "slug removes diacritics & punctuation");
      console.assert(slug("  Python  Basics  ") === "python-basics", "slug collapses spaces");
      console.assert(WEEKS.length === 12, "12 weeks expected");
      console.assert(new Set(WEEKS.map(w=>w.id)).size === WEEKS.length, "week ids unique");
      // extra test: computeProgress baseline
      const items = ["A","B","C"]; const mTitle = "Test";
      const tmp = (prog: Record<string, Record<string, boolean>>) => { const m=slug(mTitle); const d=items.filter(it=>prog[m]?.[slug(it)]).length; return Math.round((d/items.length)*100); };
      console.assert(tmp({}) === 0, "progress 0% expected");
      console.assert(computeProgress(mTitle, items) === 0, "computeProgress 0% on empty state");
      console.log("âœ” Self-tests passed");
    } catch (e) { console.error("âœ– Self-tests failed", e); }
  // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  return (
    <div className="wrap">
      <style>{styles}</style>

      <header className="header">
        <div>
          <div className="title">Plan Python & Data â€” <span style={{ color: "var(--blue)" }}>Mathilde Martine Paisley</span></div>
          <div className="sub">RÃ´le : <strong>Cheffe/Direction de projet</strong> (SIRH, Data, Digital) â€¢ Objectif : maÃ®triser <strong>mÃ©canismes</strong> (Python, APIs, SQL, Dataâ€‘Viz) sans devenir dev.</div>
        </div>
        <div className="badge tiny">Cadence : <strong>2 soirs Ã— 1h</strong> + <strong>1 matinÃ©e weekâ€‘end Ã— 2h</strong></div>
      </header>

      {/* Timeline */}
      <section className="card">
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 10 }}>
          <h2>Frise chronologique (12 semaines)</h2>
          <div className="legend">
            <span className="dot" style={{ background: "var(--blue)" }} />FÃ©vrier
            <span className="dot" style={{ background: "var(--green)" }} />Mars
            <span className="dot" style={{ background: "var(--orange)" }} />Avril
          </div>
        </div>

        <div className="timeline">
          <div className="tl">
            {weeks.map((w, i) => (
              <button key={w.id} className="b" onClick={() => setActiveWeek(w)} aria-label={`${w.label} â€“ ${w.title}`} title={w.title}>
                {i>0 && <span className="line"/>}
                <span className="ball" style={{ background: w.color }}><span style={{ fontSize: 11 }}>{w.label}</span></span>
                <span className="tiny" style={{ fontWeight: 600 }}>{w.month}</span>
                <span className="tiny muted" style={{ maxWidth: 120, textAlign: "center" }}>{w.title}</span>
              </button>
            ))}
          </div>
        </div>
        <div className="spacer" />
        <div className="week">
          <div className="tiny muted">Semaine active</div>
          <div><strong>{activeWeek.label} â€“ {activeWeek.title}</strong></div>
          <div className="muted tiny">Mois : {activeWeek.month}</div>
          <ul className="tiny" style={{ marginTop: 6 }}>{activeWeek.tasks.map((t, idx) => <li key={idx}>{t}</li>)}</ul>
        </div>
      </section>

      {/* Checklist */}
      <section className="card" style={{ marginTop: 16 }}>
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", gap: 10, marginBottom: 10 }}>
          <h2>Suivi des cours â€” checkâ€‘list (local)</h2>
          <div className="legend">
            <span className="dot" style={{ background: "var(--blue)" }} />Ã€ maÃ®triser
            <span className="dot" style={{ background: "var(--green)" }} />Ã€ apprendre
            <span className="dot" style={{ background: "var(--gray)" }} />Culture gÃ©nÃ©rale
          </div>
        </div>

        <div className="settings" style={{ marginBottom: 10 }}>
          <button className="btn" onClick={onExport}>Exporter progression (JSON)</button>
          <label className="btn" htmlFor="importFile">Importer progression</label>
          <input id="importFile" ref={fileRef} type="file" accept="application/json" onChange={onImport} />
          <button className="btn" onClick={onReset}>RÃ©initialiser</button>
        </div>

        <div className="grid grid-2">
          {modules.map((m) => {
            const mSlug = slug(m.title);
            const pct = computeProgress(m.title, m.items);
            const color = PRIORITY[m.prio].color;
            return (
              <div key={m.title} className="module">
                <div className="row">
                  <h3>{m.title}</h3>
                  <span className="pill right"><span className="dot" style={{ background: color }} />{PRIORITY[m.prio].label}</span>
                </div>
                <div className="kpi"><i style={{ width: `${pct}%`, background: color }} /></div>
                <ul style={{ listStyle: "none", padding: 0, margin: "10px 0 0" }}>
                  {m.items.map(it => {
                    const iSlug = slug(it);
                    const checked = !!progress[mSlug]?.[iSlug];
                    const url = links[mSlug]?.[iSlug] || "";
                    return (
                      <li key={iSlug} className="row">
                        <input type="checkbox" className="cb" checked={checked} onChange={() => toggle(m.title, it)} aria-label={`Valider ${it}`} />
                        <span className={checked ? "muted" : undefined}>{it}</span>
                        <span className="right tiny">
                          <a href={url || undefined} target="_blank" rel="noopener noreferrer" style={{ textDecoration: url ? "underline" : "none", color: url ? "var(--blue)" : undefined, opacity: url ? 1 : .4, pointerEvents: url ? "auto" : "none" }}>PDF</a>
                          <span title="Ajouter/Modifier le lien PDF" className="edit-link" onClick={() => setItemLink(m.title, it)}> ðŸ”—</span>
                        </span>
                      </li>
                    );
                  })}
                </ul>
                <div className="row" style={{ marginTop: 10 }}>
                  <button className="btn tiny" onClick={() => setProgress(prev => ({ ...prev, [mSlug]: Object.fromEntries(m.items.map(it => [slug(it), true])) }))}>Tout cocher</button>
                  <button className="btn tiny" onClick={() => setProgress(prev => ({ ...prev, [mSlug]: Object.fromEntries(m.items.map(it => [slug(it), false])) }))}>Tout dÃ©cocher</button>
                </div>
              </div>
            );
          })}
        </div>
      </section>

      <footer className="footer">ConÃ§u pour <strong>Mathilde Martine Paisley</strong> â€¢ Progression et liens PDF sauvegardÃ©s <em>en local</em> (localStorage).</footer>
    </div>
  );
}
